# ğŸ“š 18ì¥ ì˜¤ë¥˜ ì²˜ë¦¬ì™€ í…ŒìŠ¤íŠ¸

## ğŸ“– 18.1 ì½”ë£¨í‹´ ë‚´ë¶€ì—ì„œ ë˜ì ¸ì§„ ì˜¤ë¥˜ ì²˜ë¦¬

- ì¼ì‹œ ì¤‘ë‹¨ í•¨ìˆ˜ë‚˜ ì½”ë£¨í‹´ ë¹Œë” ì•ˆì— ì‘ì„±í•œ ì½”ë“œë„ ì˜ˆì™¸ë¥¼ ë°œìƒì‹œí‚¬ ìˆ˜ ìˆë‹¤.

```kotlin
fun main(): Unit = runBlocking {
    try {
        launch {
            throw UnsupportedOperationException("Ouch!")
        }
    } catch (u: UnsupportedOperationException) {
        println("Handled $u")
    }
}
```

- ì½”ë£¨í‹´ ë¹Œë”ëŠ” ì‹¤í–‰í•  ìƒˆë¡œìš´ ì½”ë£¨í‹´ì„ ìƒì„±í•˜ëŠ”ë°, ì´ ìƒˆë¡œìš´ ì½”ë£¨í‹´ì—ì„œ ë°œìƒí•œ ì˜ˆì™¸ëŠ” catch ë¸”ë¡ì— ì˜í•´ ì¡íˆì§€ ì•ŠëŠ”ë‹¤
- ìœ„ ì½”ë“œëŠ” ì˜ˆì™¸ê°€ ì¡íˆì§€ ì•ŠëŠ”ë‹¤.

```kotlin
fun main(): Unit = runBlocking {
    launch {
        try {
            throw UnsupportedOperationException("Ouch!")
        } catch (u: UnsupportedOperationException) {
            println("Handled $u")
        }
    }
}
```

- `launch`ì— ì „ë‹¬ë˜ëŠ” ëŒë‹¤ ë¸”ë¡ì•ˆì—ì„œëŠ” ì¡íŒë‹¤.

```kotlin
fun main(): Unit = runBlocking {
    val myDeferredInt: Deferred<Int> = async {
        throw UnsupportedOperationException("Ouch!")
    }
    try {
        val i: Int = myDeferredInt.await()
        println(i)
    } catch (u: UnsupportedOperationException) {
        println("Handled: $u")
    }
}
```

- `await`ë¥¼ ê°ì‹¼ `try-catch`ì—ì„œ ì˜ˆì™¸ë¥¼ ì¡ì§€ë§Œ ë™ì‹œì— ì˜ˆì™¸ë¥¼ ì¶œë ¥í•œë‹¤.
- ìì‹ ì½”ë£¨í‹´ì€ ì¡íˆì§€ ì•Šì€ ì˜ˆì™¸ë¥¼ í•­ìƒ ë¶€ëª¨ ì½”ë£¨í‹´ì— ì „íŒŒí•œë‹¤.

## ğŸ“– 18.2 ì½”í‹€ë¦° ì½”ë£¨í‹´ì—ì„œì˜ ì˜¤ë¥˜ ì „íŒŒ

- í•œ ìì‹ì˜ ì‹¤íŒ¨ê°€ ë¶€ëª¨ì˜ ì‹¤íŒ¨ë¡œ ì´ì–´ì§„ë‹¤.
- ìì‹ì˜ ì‹¤íŒ¨ë¡œ ì¸í•´ ì‹œìŠ¤í…œ ì „ì²´ê°€ ì‹¤íŒ¨í•˜ë©´ì„œ ë©ˆì¶”ì§€ëŠ” ë§ì•„ì•¼ í•˜ëŠ” ê²½ìš°ë¥¼, ìì‹ì´ ë¶€ëª¨ì˜ ì‹¤í–‰ì„ ê°ë…í•œë‹¤ê³  ë§í•œë‹¤.

### ğŸ”– 18.2.1 ìì‹ì´ ì‹¤íŒ¨í•˜ë©´ ëª¨ë“  ìì‹ì„ ì·¨ì†Œí•˜ëŠ” ì½”ë£¨í‹´

```kotlin
fun main(): Unit = runBlocking {
    launch {
        try {
            while (true) {
                println("Heartbeat!")
                delay(500.milliseconds)
            }
        } catch (e: Exception) {
            println("Heartbeat terminated: $e")
            throw e
        }
    }
    launch {
        delay(1.seconds)
        throw UnsupportedOperationException("Ow!")
    }
}
```

```text
Heartbeat!
Heartbeat!
Heartbeat terminated: kotlinx.coroutines.JobCancellationException: Parent job is Cancelling; job="coroutine#1":BlockingCoroutine{Cancelling}@130f889
Exception in thread "main" java.lang.UnsupportedOperationException: Ow!
```

- í˜•ì œ ì½”ë£¨í‹´ ì¤‘ í•˜ë‚˜ê°€ ì˜ˆì™¸ë¥¼ ë˜ì§€ë©´ í•˜íŠ¸ë¹„íŠ¸ ì½”ë£¨í‹´ë„ ì·¨ì†Œëœë‹¤.
- ê°™ì€ ìŠ¤ì½”í”„ ì•ˆì—ì„œ ë™ì‹œì„± ê³„ì‚°ì„ í•¨ê»˜ ìˆ˜í–‰í•˜ê³  ê³µí†µì˜ ê²°ê³¼ë¥¼ ë°˜í™˜í•˜ëŠ” ì½”ë£¨í‹´ ê·¸ë£¹ì—ê²Œ ì•„ì£¼ ìœ ìš©í•˜ë‹¤.

### ğŸ”– 18.2.2 êµ¬ì¡°ì  ë™ì‹œì„±ì€ ì½”ë£¨í‹´ ìŠ¤ì½”í”„ë¥¼ ë„˜ëŠ” ì˜ˆì™¸ì—ë§Œ ì˜í–¥ì„ ë¯¸ì¹œë‹¤

```kotlin
fun main(): Unit = runBlocking {
    launch {
        try {
            while (true) {
                println("Heartbeat!")
                delay(500.milliseconds)
            }
        } catch (e: Exception) {
            println("Heartbeat terminated: $e")
            throw e
        }
    }
    launch {
        try {
            delay(1.seconds)
            throw UnsupportedOperationException("Ow!")
        } catch (u: UnsupportedOperationException) {
            println("Caught $u")
        }
    }
}
```

- ì˜ˆì™¸ê°€ ë°œìƒí•œ ë‹¤ìŒì—ë„ í•˜íŠ¸ë¹„íŠ¸ ì½”ë£¨í‹´ì´ ê³„ì† í…ìŠ¤íŠ¸ë¥¼ ì¶œë ¥
- ì²˜ë¦¬ë˜ì§€ ì•Šì€ ì˜ˆì™¸ë¥¼ ì½”ë£¨í‹´ ê³„ì¸µ ìœ„ìª½ìœ¼ë¡œ ì „íŒŒí•˜ê³  í˜•ì œ ì½”ë£¨í‹´ì„ ì·¨ì†Œí•˜ëŠ” ê²ƒì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ êµ¬ì¡°ì  ë™ì‹œì„± íŒ¨ëŸ¬ë‹¤ì„ì„ ê°•ì œí•˜ëŠ” ë° ë„ì›€ì´ ëœë‹¤.

### ğŸ”– 18.2.3 ìŠˆí¼ë°”ì´ì €ëŠ” ë¶€ëª¨ì™€ í˜•ì œê°€ ì·¨ì†Œë˜ì§€ ì•Šê²Œ í•œë‹¤

```kotlin
fun main(): Unit = runBlocking {
    supervisorScope {
        launch {
            try {
                while (true) {
                    println("Heartbeat!")
                    delay(500.milliseconds)
                }
            } catch (e: Exception) {
                println("Heartbeat terminated: $e")
                throw e
            }
        }
        launch {
            delay(1.seconds)
            throw UnsupportedOperationException("Ow!")
        }
    }
}
```

- ìì‹ ì½”ë£¨í‹´ì´ ë¶€ëª¨ ì½”ë£¨í‹´ì„ ì·¨ì†Œí•˜ì§€ ëª»í•˜ê²Œ ìŠˆí¼ë°”ì´ì €ê°€ ë§‰ëŠ”ë‹¤.
- ìŠˆí¼ë°”ì´ì €ëŠ” ìì‹ì´ ì‹¤íŒ¨í•˜ë”ë¼ë„ ìƒì¡´
- ìŠˆí¼ë°”ì´ì €ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì½”ë£¨í‹´ ê³„ì¸µì˜ ìœ„ìª½ì— ìœ„ì¹˜í•˜ëŠ” ê²½ìš°ê°€ ë§ë‹¤.

## ğŸ“– 18.3 CoroutineExceptionHandler: ì˜ˆì™¸ ì²˜ë¦¬ë¥¼ ìœ„í•œ ë§ˆì§€ë§‰ ìˆ˜ë‹¨

- ì²˜ë¦¬ë˜ì§€ ì•ŠëŠ” ì˜ˆì™¸ëŠ” `CoroutineExceptionHandler`ë¼ëŠ” íŠ¹ë³„í•œ í•¸ë“¤ëŸ¬ì—ê²Œ ì „ë‹¬ëœë‹¤.
- `CoroutineExceptionHandler`ë¥¼ ì½”ë£¨í‹´ ì½˜í…ìŠ¤íŠ¸ì— ì œê³µí•˜ë©´ ì²˜ë¦¬ë˜ì§€ ì•Šì€ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë™ì‘ì„ ì»¤ìŠ¤í…€í™”í•  ìˆ˜ ìˆë‹¤.

```kotlin
fun main(): Unit = runBlocking {
    val supervisor = ComponentWithScope()
    supervisor.action()
    delay(1.seconds)
}

class ComponentWithScope(dispatcher: CoroutineDispatcher = Dispatchers.Default) {
    private val exceptionHandler = CoroutineExceptionHandler { _, e ->
        println("[ERROR] ${e.message}")
    }
    private val scope = CoroutineScope(
        SupervisorJob() + dispatcher + exceptionHandler
    )

    fun action() = scope.launch {
        throw UnsupportedOperationException("Ouch!")
    }
}
```

- ì»¤ìŠ¤í…€ ì½”ë£¨í‹´ ì˜ˆì™¸ í•¸ë“¤ëŸ¬ë¥¼ ê°€ì§„ ì»´í¬ë„ŒíŠ¸

```kotlin
private val topLevelHandler = CoroutineExceptionHandler { _, e ->
    println("[TOP] ${e.message}")
}

private val intermediateHandler = CoroutineExceptionHandler { _, e ->
    println("[INTERMEDIATE] ${e.message}")
}

@OptIn(DelicateCoroutinesApi::class)
fun main() {
    GlobalScope.launch(topLevelHandler) {
        launch(intermediateHandler) {
            throw UnsupportedOperationException("Ouch!")
        }
    }
    Thread.sleep(1000)
}
```

- ì½”ë£¨í‹´ ê³„ì¸µì˜ ìµœìƒìœ„ì— ìˆëŠ” ì˜ˆì™¸ í•¸ë“¤ëŸ¬ë§Œ í˜¸ì¶œëœë‹¤.

### ğŸ”– 18.3.1 CoroutineExceptionHandlerë¥¼ launchì™€ asyncì— ì ìš©í•  ë•Œì˜ ì°¨ì´ì 

```kotlin
class ComponentWithScope(dispatcher: CoroutineDispatcher = Dispatchers.Default) {
    private val exceptionHandler = CoroutineExceptionHandler { _, e ->
        println("[ERROR] ${e.message}")
    }
    private val scope = CoroutineScope(
        SupervisorJob() + dispatcher + exceptionHandler
    )

    fun action() = scope.launch {
        async {
            throw UnsupportedOperationException("Ouch!")
        }
    }
}

fun main() {
    val supervisor = ComponentWithScope()
    supervisor.action()
    delay(1.seconds)
}
```

- ìŠˆí¼ë°”ì´ì €ì˜ ì§ì ‘ì ì¸ ìì‹ì´ë©´ì„œ ì˜ˆì™¸ë¥¼ ë˜ì§€ëŠ” async ì½”ë£¨í‹´
- ìµœìƒìœ„ ì½”ë£¨í‹´ì´ `async`ë¡œ ì‹œì‘ë˜ë©´ ì´ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì±…ì„ì€ `await()`ë¥¼ í˜¸ì¶œí•˜ëŠ” `Deferred` ì†Œë¹„ìì—ê²Œ ìˆë‹¤.

## ğŸ“– 18.4 í”Œë¡œìš°ì—ì„œ ì˜ˆì™¸ ì²˜ë¦¬

```kotlin
class UnhappyFlowException : Exception()

val exceptionalFlow = flow {
    repeat(5) { number ->
        emit(number)
    }
    throw UnhappyFlowException()
}
```

- 5ê°œì˜ ìˆ«ìë¥¼ ë°©ì¶œí•œ í›„ ì˜ˆì™¸ë¥¼ ë˜ì§€ëŠ” í”Œë¡œìš°
- ì¼ë°˜ì ìœ¼ë¡œ í”Œë¡œìš°ì˜ ì¼ë¶€ë¶„ì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ `collect`ì—ì„œ ì˜ˆì™¸ê°€ ë˜ì ¸ì§„ë‹¤.

### ğŸ”– 18.4.1 catch ì—°ì‚°ìë¡œ ì—…ìŠ¤íŠ¸ë¦¼ ì˜ˆì™¸ ì²˜ë¦¬

```kotlin
fun main() = runBlocking {
    exceptionalFlow
        .catch { cause ->
            println("\nHandled: $cause")
            emit(-1)
        }
        .collect {
            println("$it ")
        }
}
```

- `catch`ëŠ” í”Œë¡œìš°ì—ì„œ ë°œìƒí•œ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ì¤‘ê°„ ì—°ì‚°ì
- ì´ í•¨ìˆ˜ì— ì—°ê²°ëœ ëŒë‹¤ ì•ˆì—ì„œ í”Œë¡œìš°ì— ë°œìƒí•œ ì˜ˆì™¸ì— ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤.

```kotlin
fun main() = runBlocking {
    exceptionalFlow
        .map { 
            it + 1
        }
        .catch { cause ->
            println("\nHandled: $cause")
        }
        .onEach { 
            throw UnhappyFlowException()
        }
        .collect()
}
```

- `catch`ëŠ” ì—…ìŠ¤íŠ¸ë¦¼ì— ëŒ€í•´ì„œë§Œ ì‘ë™í•˜ë©°, í”Œë¡œìš° ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸ì˜ ì•ìª½ì—ì„œ ë°œìƒí•œ ì˜ˆì™¸ë“¤ë§Œ ì¡ì•„ë‚¸ë‹¤.

### ğŸ”– 18.4.2 ìˆ ì–´ê°€ ì°¸ì¼ ë•Œ í”Œë¡œìš°ì˜ ìˆ˜ì§‘ ì¬ì‹œë„: retry ì—°ì‚°ì

```kotlin
val unreliableFlow = flow {
    println("Starting the flow!")
    repeat(10) { number ->
        if (Random.nextDouble() < 0.1) throw CommunicationException()
        emit(number)
    }
}

fun main() = runBlocking {
    unreliableFlow
        .retry(5) { cause ->
            println("\nHandled: $cause")
            cause is CommunicationException
        }
        .collect { number ->
            println("$number")
        }
}
```

- `retry` ì—°ì‚°ìëŠ” ì—…ìŠ¤íŠ¸ë¦¼ì˜ ì˜ˆì™¸ë¥¼ ì¡ëŠ”ë‹¤.
- ì¬ì‹œë„í•  ë•ŒëŠ” ì—…ìŠ¤íŠ¸ë¦¼ ì—°ì‚°ìê°€ ë³´ë‘ ë‹¤ì‹œ ì‹¤í–‰ëœë‹¤.

## ğŸ“– 18.5 ì½”ë£¨í‹´ê³¼ í”Œë¡œìš° í…ŒìŠ¤íŠ¸

### ğŸ”– 18.5.1 ì½”ë£¨í‹´ì„ ì‚¬ìš©í•˜ëŠ” í…ŒìŠ¤íŠ¸ë¥¼ ë¹ ë¥´ê²Œ ë§Œë“¤ê¸°: ê°€ìƒ ì‹œê°„ê³¼ í…ŒìŠ¤íŠ¸ ë””ìŠ¤íŒ¨ì²˜

```kotlin
class PlaygroundTest {

    @Test
    fun testDelay() = runTest {
        val startTime = System.currentTimeMillis()
        delay(20.seconds)
        println(System.currentTimeMillis() - startTime)
    }
}
```

- `runTest`ëŠ” ì†ë„ë¥¼ ë†’ì´ê¸° ìœ„í•´ íŠ¹ë³„í•œ í…ŒìŠ¤íŠ¸ ë””ìŠ¤íŒ¨ì²˜ì™€ ìŠ¤ì¼€ì¤„ëŸ¬ë¥¼ ì‚¬ìš©
- `runTest`ì˜ ë””ìŠ¤íŒ¨ì²˜ëŠ” ë‹¨ì¼ ìŠ¤ë ˆë“œ

```kotlin
@OptIn(ExperimentalCoroutinesApi::class)
@Test
fun testDelay() = runTest {
    var x = 0
    launch {
        delay(500.milliseconds)
        x++
    }
    launch {
        delay(1.seconds)
        x++
    }
    println(currentTime)

    delay(600.milliseconds)
    assertEquals(1, x)
    println(currentTime)

    delay(500.milliseconds)
    assertEquals(2, x)
    println(currentTime)
}
```

- `delay`ë¥¼ í†µí•´ ê°€ìƒ ì‹œê³„ ì§„í–‰

```kotlin
@OptIn(ExperimentalCoroutinesApi::class)
@Test
fun testDelay() = runTest {
    var x = 0
    launch { 
        x++
        launch { 
            x++
        }
    }
    launch { 
        delay(200.milliseconds)
        x++
    }
    runCurrent()
    assertEquals(2, x)
    advanceUntilIdle()
    assertEquals(3, x)
}
```

- ë¯¸ë˜ì˜ ì–´ëŠ ì‹œì ì— ì‹¤í–‰í•˜ë„ë¡ ì˜ˆì•½ëœ ì½”ë£¨í‹´ê¹Œì§€ ì‹¤í–‰í•˜ë ¤ë©´ `advanceUntilIdle` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

### ğŸ”– 18.5.2 í„°ë¹ˆìœ¼ë¡œ í”Œë¡œìš° í…ŒìŠ¤íŠ¸

```kotlin
val myFlow = flow { 
    emit(1)
    emit(2)
    emit(3)
}

@Test
fun doTest() = runTest { 
    val results = myFlow.toList()
    assertEquals(3, results.size)
}
```

- í”Œë¡œìš°ë¥¼ ë¦¬ìŠ¤íŠ¸ë¡œ ìˆ˜ì§‘í•´ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```kotlin
@Test
fun doTest() = runTest { 
    val results = myFlow.test {
        assertEquals(1, awaitItem())
        assertEquals(2, awaitItem())
        assertEquals(3, awaitItem())
        awaitComplete()
    }
}
```

- í„°ë¹ˆì€ ì„œë“œíŒŒí‹° ë¼ì´ë¸ŒëŸ¬ë¦¬ì§€ë§Œ í•„ìˆ˜ì ì´ë‹¤.
- í”Œë¡œìš°ê°€ ë°©ì¶œí•œ ëª¨ë“  ì›ì†Œê°€ í…ŒìŠ¤íŠ¸ì— ì˜í•´ ì ì ˆíˆ ì†Œë¹„ë˜ë„ë¡ ë³´ì¥
